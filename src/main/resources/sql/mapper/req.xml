<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.req.mapper.ReqMapper">

	<sql id="selectReq">
		SELECT 
			ROW_NUMBER() OVER(ORDER BY REQ.REQ_SEQ) AS rowNum
			, REQ.REQ_SEQ AS reqSeq
			, REQ.REQ_NO AS reqNo
			, REQ.COMP_SEQ AS compSeq
			, COMP.COMP_NM AS compNm
			, REQ.PROJ_SEQ AS projSeq
			, PROJ.PROJ_NM AS projNm
			, REQ.SITE_SEQ AS siteSeq
			, SITE.SITE_NM AS siteNm
			, REQ.REQ_YMD AS reqYmd
			, REQ.REQ_TYPE_CD AS reqTypeCd
			, REQ_TYPE_CODE.CODE_NM AS reqType
			, REQ.REQ_GB_CD AS reqGbCd
			, REQ_GB_CODE.CODE_NM AS reqGb
			, REQ.REQ_END_YMD AS reqEndYmd
			, REQ.REQ_CONTENTS_TXT AS reqContentsTxt
			, REQ.AGREE_YN AS agreeYn
			, REQ.AGREE_DT AS agreeDt
			, REQ.AGREE_USER_SEQ AS agreeUserSeq
			, AGREE_USER.USER_NM AS agreeUserNm
			, REQ.DEL_YN AS delYn
			, REQ.REASON_TXT AS reasonTxt
			, DATE_FORMAT(REQ.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, REG_USER.USER_NM AS regNm
			, DATE_FORMAT(REQ.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, UPDT_USER.USER_NM AS updtNm
			, 'TB_REQ' AS fileRefTb
			, 'REQ_SEQ' AS fileRefCol			
		FROM TB_REQ REQ
		INNER JOIN TB_COMPANY COMP ON REQ.COMP_SEQ = COMP.COMP_SEQ
		INNER JOIN TB_PROJ PROJ ON REQ.PROJ_SEQ = PROJ.PROJ_SEQ
		INNER JOIN TB_SITE SITE ON REQ.SITE_SEQ = SITE.SITE_SEQ
		LEFT JOIN TB_CODE REQ_TYPE_CODE ON REQ.REQ_TYPE_CD = REQ_TYPE_CODE.CODE_CD 
			AND REQ_TYPE_CODE.UP_CODE_CD = 'REQ_TYPE_CD'  
		LEFT JOIN TB_CODE REQ_GB_CODE ON REQ.REQ_GB_CD = REQ_GB_CODE.CODE_CD 
			AND REQ_GB_CODE.UP_CODE_CD = 'REQ_GB_CD'      
		LEFT JOIN TB_USER AGREE_USER ON REQ.AGREE_USER_SEQ = AGREE_USER.USER_SEQ
		LEFT JOIN TB_USER REG_USER ON REQ.REG_SEQ = REG_USER.USER_SEQ
		LEFT JOIN TB_USER UPDT_USER ON REQ.UPDT_SEQ = UPDT_USER.USER_SEQ 
		WHERE REQ.DEL_YN = 'N'
	</sql>

	<resultMap id="resultReqMap" type="com.iwi.iwms.api.req.domain.ReqInfo">
		<result property="rowNum" column="rowNum"/>
		<result property="reqSeq" column="reqSeq"/>
		<result property="reqNo" column="reqNo"/>
		<result property="siteSeq" column="siteSeq"/>
		<result property="siteNm" column="siteNm"/>
		<result property="reqYmd" column="reqYmd"/>
		<result property="reqTypeCd" column="reqTypeCd"/>
		<result property="reqType" column="reqType"/>
		<result property="reqGbCd" column="reqGbCd"/>
		<result property="reqGb" column="reqGb"/>
		<result property="reqEndYmd" column="reqEndYmd"/>
		<result property="reqContentsTxt" column="reqContentsTxt"/>
		<result property="agreeYn" column="agreeYn"/>
		<result property="agreeDt" column="agreeDt"/>
		<result property="agreeUserSeq" column="agreeUserSeq"/>
		<result property="agreeUserNm" column="agreeUserNm"/>
		<result property="delYn" column="delYn"/>
		<result property="reasonTxt" column="reasonTxt"/>
		<result property="regDt" column="regDt"/>
		<result property="regNm" column="regNm"/>
		<result property="updtDt" column="updtDt"/>
		<result property="updtNm" column="updtNm"/>
			
	   	<collection property="attachedFiles" column="fileRefTb=fileRefTb,fileRefCol=fileRefCol,fileRefSeq=reqSeq" 
			ofType="com.iwi.iwms.api.file.domain.UploadFileInfo" select="com.iwi.iwms.api.file.mapper.FileMapper.listFileByRef"/>

	   	<collection property="comments" column="reqSeq" 
			ofType="com.iwi.iwms.api.req.domain.ReqCmtInfo" select="com.iwi.iwms.api.req.mapper.ReqCmtMapper.listReqCmtByReqSeq"/>			
						
	   	<collection property="details" column="reqSeq" 
			ofType="com.iwi.iwms.api.req.domain.ReqDtlInfo" select="com.iwi.iwms.api.req.mapper.ReqDtlMapper.listReqDtlByReqSeq"/>			
			
	</resultMap>
	
	<!-- 요청사항 목록 조회 -->		
	<select id="listReq" parameterType="hashMap"
		resultMap="resultReqMap">
		<include refid="selectReq"></include>
		<if test='search != null and search != ""'>
			AND REQ.REQ_NO LIKE CONCAT('%', #{search}, '%') 
			OR COMP.COMP_NM LIKE CONCAT('%', #{search}, '%')
			OR PROJ.PROJ_NM LIKE CONCAT('%', #{search}, '%') 
			OR SITE.SITE_NM LIKE CONCAT('%', #{search}, '%') 
			OR REQ.REQ_CONTENTS_TX LIKE CONCAT('%', #{search}, '%') 
		</if>			
		ORDER BY REQ.REQ_SEQ DESC
		<if test='pagination != null and pagination != ""'>
			LIMIT #{pagination.limitPerPage} OFFSET #{pagination.offset}
		</if>
	</select>	
	
	<!-- 요청사항 수 -->
	<select id="countReq" parameterType="hashMap"
		resultType="int">
		SELECT 
			COUNT(REQ_SEQ)
		FROM TB_REQ
		WHERE DEL_YN = 'N'
		<if test='search != null and search != ""'>
			AND REQ.REQ_NO LIKE CONCAT('%', #{search}, '%') 
			OR COMP.COMP_NM LIKE CONCAT('%', #{search}, '%')
			OR PROJ.PROJ_NM LIKE CONCAT('%', #{search}, '%') 
			OR SITE.SITE_NM LIKE CONCAT('%', #{search}, '%') 
			OR REQ.REQ_CONTENTS_TX LIKE CONCAT('%', #{search}, '%') 
		</if>				
	</select>	

	<!-- 요청사항 단일 조회 -->	
	<select id="getReqBySeq" parameterType="long"
		resultMap="resultReqMap">
		<include refid="selectReq"></include>
		AND REQ.REQ_SEQ = #{reqSeq}
	</select>	

	<!-- 요청사항 등록 -->	
	<insert id="insertReq" parameterType="com.iwi.iwms.api.req.domain.Req"
		useGeneratedKeys="true" keyProperty="reqSeq">
		
		INSERT INTO TB_REQ
		(
		    REQ_NO
		    , SITE_SEQ
			, PROJ_SEQ
			, COMP_SEQ
			, REQ_YMD
			, REQ_TYPE_CD
			, REQ_GB_CD
			, REQ_END_YMD
			, REQ_CONTENTS_TXT
			, DEL_YN
			, REG_DT
			, REG_SEQ
		) VALUES (
		    (
				SELECT 
					CONCAT('R', DATE_FORMAT(CURRENT_TIMESTAMP, "%y"), '-', LPAD(COALESCE(MAX(SUBSTR(S_REQ.REQ_NO, 5)), 0) + 1, 6, 0))
				FROM TB_REQ AS S_REQ
				WHERE S_REQ.REQ_NO LIKE CONCAT('R', DATE_FORMAT(CURRENT_TIMESTAMP, "%y"), '%')
				LIMIT 1		    
		    )
			, #{siteSeq}
			, #{projSeq}
			, (SELECT COMP_SEQ FROM TB_PROJ WHERE PROJ_SEQ = #{projSeq})
			, DATE_FORMAT(CURRENT_TIMESTAMP, "%Y%m%d")
			, #{reqTypeCd}
			, #{reqGbCd}
			, #{reqEndYmd}
			, #{reqContentsTxt}
			, 'N'
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
	</insert>		

	<!-- 요청사항 수정 -->
	<update id="updateReq" parameterType="com.iwi.iwms.api.req.domain.Req">
		UPDATE TB_REQ 
		SET
		   REQ_TYPE_CD = #{reqTypeCd}
			, REQ_GB_CD = #{reqGbCd}
			, REQ_END_YMD = #{reqEndYmd}
			, REQ_CONTENTS_TXT = #{reqContentsTxt}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE REQ_SEQ = #{reqSeq}	
	</update>	
	
	<!-- 요청사항 삭제 -->
	<delete id="deleteReq" parameterType="com.iwi.iwms.api.req.domain.Req">
		DELETE 
		FROM TB_REQ
		WHERE REQ_SEQ = #{reqSeq}	 
	</delete>

	<!-- 요청사항 취소 -->
	<update id="cancelReq" parameterType="com.iwi.iwms.api.req.domain.ReqCancel">
		UPDATE TB_REQ 
		SET
		   REASON_TXT = #{reasonTxt}
			, DEL_YN = 'Y'
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE REQ_SEQ = #{reqSeq}	
	</update>	
	
	<!-- 요청사항 합의 -->	
	<update id="agreeReq" parameterType="com.iwi.iwms.api.req.domain.ReqAgree">
		UPDATE TB_REQ 
		SET
		    AGREE_YN = #{agreeYn}
			, AGREE_DT = CURRENT_TIMESTAMP
			, AGREE_USER_SEQ = #{updtSeq}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE REQ_SEQ = #{reqSeq}	
	</update>			
		
</mapper>