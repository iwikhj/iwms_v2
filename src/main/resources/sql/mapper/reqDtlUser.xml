<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.req.mapper.ReqDtlUserMapper">
	
	<sql id="selectReqDtlUser">
		SELECT
			ROW_NUMBER() OVER(ORDER BY USER.REQ_DTL_USER_SEQ) AS rowNum
			, USER.REQ_DTL_USER_SEQ AS reqDtlUserSeq
			, CMT.REQ_DTL_USER_CMT_SEQ AS reqDtlUserCmtSeq
			, REQ.REQ_SEQ AS reqSeq
			, REQ.REQ_NO AS reqNo
			, DTL.REQ_DTL_SEQ AS reqDtlSeq
			, DTL.REQ_DTL_NO AS reqDtlNo
			, USER.USER_SEQ AS userSeq
			, ASS_USER.USER_NM AS userNm
			, USER.BUSI_ROLL_CD AS busiRollCd
			, CODE1.CODE_NM AS busiRoll
			, USER.PROC_YMD AS procYmd
			, USER.PROC_HH AS procHh
			, USER.REQ_DTL_STAT_CD AS reqDtlStatCd
			, CODE2.CODE_NM AS reqDtlStat
			, CMT.REQ_DTL_STD_YMD AS reqDtlStdYmd
			, CMT.REQ_DTL_STD_PART AS reqDtlStdPart
			, CMT.REQ_DTL_END_YMD AS reqDtlEndYmd
			, CMT.REQ_DTL_END_PART AS reqDtlEndPart
			, CMT.CMT AS cmt
			, CMT.MNG_MAIN_YN AS mngMainYn
			, DATE_FORMAT(USER.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, REG_USER.USER_NM AS regNm
		FROM TB_REQ REQ
		INNER JOIN TB_REQ_DTL DTL ON REQ.REQ_SEQ = DTL.REQ_SEQ
		INNER JOIN TB_REQ_DTL_USER USER ON DTL.REQ_DTL_SEQ = USER.REQ_DTL_SEQ
		INNER JOIN TB_REQ_DTL_USER_CMT CMT ON USER.REQ_DTL_USER_SEQ = CMT.REQ_DTL_USER_SEQ
		LEFT JOIN TB_CODE CODE1 ON USER.BUSI_ROLL_CD = CODE1.CODE_CD 
			AND CODE1.UP_CODE_CD = 'BUSI_ROLL_CD'  
		LEFT JOIN TB_CODE CODE2 ON USER.REQ_DTL_STAT_CD = CODE2.CODE_CD 
			AND CODE2.UP_CODE_CD = 'REQ_DTL_STAT_CD'  
		LEFT JOIN TB_USER ASS_USER ON USER.USER_SEQ = ASS_USER.USER_SEQ
		LEFT JOIN TB_USER REG_USER ON USER.REG_SEQ = REG_USER.USER_SEQ
		WHERE 1 = 1
	</sql>	

	<resultMap id="resultReqDtlUserMap" type="com.iwi.iwms.api.req.domain.ReqDtlUserInfo">
		<result property="rowNum" column="rowNum"/>
		<result property="reqDtlUserSeq" column="reqDtlUserSeq"/>
		<result property="reqDtlUserCmtSeq" column="reqDtlUserCmtSeq"/>
		<result property="reqSeq" column="reqSeq"/>
		<result property="reqNo" column="reqNo"/>
		<result property="reqDtlSeq" column="reqDtlSeq"/>
		<result property="reqDtlNo" column="reqDtlNo"/>
		<result property="userSeq" column="userSeq"/>
		<result property="userNm" column="userNm"/>
		<result property="busiRollCd" column="busiRollCd"/>
		<result property="busiRoll" column="busiRoll"/>
		<result property="procYmd" column="procYmd"/>
		<result property="procHh" column="procHh"/>
		<result property="reqDtlStdYmd" column="reqDtlStdYmd"/>
		<result property="reqDtlStdPart" column="reqDtlStdPart"/>
		<result property="reqDtlEndYmd" column="reqDtlEndYmd"/>
		<result property="reqDtlEndPart" column="reqDtlEndPart"/>
		<result property="cmt" column="cmt"/>
		<result property="mngMainYn" column="mngMainYn"/>
		<result property="reqDtlStatCd" column="reqDtlStatCd"/>
		<result property="reqDtlStat" column="reqDtlStat"/>
		<result property="regDt" column="regDt"/>
		<result property="regNm" column="regNm"/>
	</resultMap>
	
	<!-- 요청사항 상세 담당자 목록 조회 -->		
	<select id="listReqDtlUserByReqDtlSeq" parameterType="long"
		resultMap="resultReqDtlUserMap">
		<include refid="selectReqDtlUser"></include>
			AND USER.REQ_DTL_SEQ = #{reqDtlSeq}
		ORDER BY USER.REQ_DTL_USER_SEQ DESC	
	</select>	
		
	<!-- 요청사항 상세 담당자 단일 조회 -->					
	<select id="getReqDtlUserBySeq" parameterType="long"
		resultMap="resultReqDtlUserMap">
		<include refid="selectReqDtlUser"></include>
			AND USER.REQ_DTL_USER_SEQ = #{reqDtlUserSeq}
	</select>		
	
	<!-- 요청사항 상세 담당자 등록 -->		
	<insert id="insertReqDtlUser" parameterType="com.iwi.iwms.api.req.domain.ReqDtlUser">
		INSERT INTO TB_REQ_DTL_USER
		(
		    REQ_DTL_SEQ
		    , USER_SEQ
			, BUSI_ROLL_CD
			, PROC_YMD
			, PROC_HH
			, REQ_DTL_STAT_CD
			, REG_DT
			, REG_SEQ
		) VALUES (
			#{reqDtlSeq}
			, #{userSeq}
			, (SELECT USER_BUSI_CD FROM TB_USER WHERE USER_SEQ = #{userSeq})
			, #{procYmd}
			, #{procHh}
			, #{reqDtlStatCd}
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)	
		<selectKey keyColumn="REQ_DTL_USER_SEQ,BUSI_ROLL_CD" keyProperty="reqDtlUserSeq,busiRollCd" resultType="map" order="AFTER">
        	SELECT 
        		REQ_DTL_USER_SEQ
        		, BUSI_ROLL_CD
        	FROM TB_REQ_DTL_USER
        	WHERE REQ_DTL_USER_SEQ = LAST_INSERT_ID()
    	</selectKey>			
	</insert>	

	<!-- 요청사항 상세 담당자 수정 -->		
	<update id="updateReqDtlUser" parameterType="com.iwi.iwms.api.req.domain.ReqDtlUser">
		UPDATE TB_REQ_DTL_USER 
		SET
		   PROC_YMD = #{procYmd}
			, PROC_HH = #{procHh}
			, REQ_DTL_STAT_CD = #{reqDtlStatCd}
			, REG_DT = CURRENT_TIMESTAMP
			, REG_SEQ = #{regSeq}			
		WHERE REQ_DTL_USER_SEQ = #{reqDtlUserSeq}	
	</update>	
	
	<!-- 요청사항 상세 담당자 삭제 -->		
	<delete id="deleteReqDtlUser" parameterType="com.iwi.iwms.api.req.domain.ReqDtlUser">
		DELETE 
		FROM TB_REQ_DTL_USER
		WHERE REQ_DTL_USER_SEQ = #{reqDtlUserSeq}	 
	</delete>
	
	<!-- 요청사항 상세 담당자 코멘트 등록 -->		
	<insert id="insertReqDtlUserCmt" parameterType="com.iwi.iwms.api.req.domain.ReqDtlUser">
		INSERT INTO TB_REQ_DTL_USER_CMT
		(
		    REQ_DTL_USER_SEQ
		    , USER_SEQ
			, REQ_DTL_STD_YMD
			, REQ_DTL_STD_PART
			, REQ_DTL_END_YMD
			, REQ_DTL_END_PART
			, REQ_DTL_STAT_CD
			, CMT
			, MNG_MAIN_YN
			, REG_DT
		) VALUES (
			#{reqDtlUserSeq}
			, #{userSeq}
			, #{reqDtlStdYmd}
			, #{reqDtlStdPart}
			, #{reqDtlEndYmd}
			, #{reqDtlEndPart}
			, #{reqDtlStatCd}
			, #{cmt}
			, #{mngMainYn}
			, CURRENT_TIMESTAMP
		)		
	</insert>		

	<!-- 요청사항 상세 담당자 코멘트 수정 -->	
	<update id="updateReqDtlUserCmt" parameterType="com.iwi.iwms.api.req.domain.ReqDtlUser">
		UPDATE TB_REQ_DTL_USER_CMT 
		SET
		   REQ_DTL_STD_YMD = #{reqDtlStdYmd}
			, REQ_DTL_STD_PART = #{reqDtlStdPart}
			, REQ_DTL_END_YMD = #{reqDtlEndYmd}
			, REQ_DTL_END_PART = #{reqDtlEndPart}
			, REQ_DTL_STAT_CD = #{reqDtlStatCd}
			, CMT = #{cmt}
			, MNG_MAIN_YN = #{mngMainYn}
			, REG_DT = CURRENT_TIMESTAMP
		WHERE REQ_DTL_USER_SEQ = #{reqDtlUserSeq}	
	</update>	
			
</mapper>