<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.comp.mapper.SiteMapper">
	
	<sql id="selectSite">
		SELECT 
			ROW_NUMBER() OVER(ORDER BY SITE.SITE_SEQ) AS rowNum
			, SITE.SITE_SEQ AS siteSeq
			, SITE.COMP_SEQ AS compSeq
			, COMP.COMP_NM AS compNm
			, SITE.PROJ_SEQ AS projSeq
			, PROJ.PROJ_NM AS projNm
			, PROJ.PROJ_SW_NM AS projSwNm
			, PROJ.PROJ_STD_YMD AS projStdYmd
			, PROJ.PROJ_END_YMD AS projEndYmd			
			, SITE.SITE_NM AS siteNm
			, SITE.SITE_SW_NM AS siteSwNm
			, SITE.SITE_GB_CD AS siteGbCd
			, SITE_GB_CODE.CODE_NM AS siteGb
			, SITE.USE_YN AS useYn
			, DATE_FORMAT(SITE.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, REG_USER.USER_NM AS regNm
			, DATE_FORMAT(SITE.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, UPDT_USER.USER_NM AS updtNm
		FROM TB_SITE SITE
		INNER JOIN TB_COMPANY COMP ON SITE.COMP_SEQ = COMP.COMP_SEQ
		INNER JOIN TB_PROJ PROJ ON SITE.PROJ_SEQ = PROJ.PROJ_SEQ
		LEFT JOIN TB_CODE SITE_GB_CODE ON SITE.SITE_GB_CD = SITE_GB_CODE.CODE_CD AND SITE_GB_CODE.UP_CODE_CD = 'SITE_GB_CD'    
		LEFT JOIN TB_USER REG_USER ON SITE.REG_SEQ = REG_USER.USER_SEQ
		LEFT JOIN TB_USER UPDT_USER ON SITE.UPDT_SEQ = UPDT_USER.USER_SEQ 
		WHERE SITE.USE_YN = 'Y'
	</sql>

	<resultMap id="resultSiteMap" type="com.iwi.iwms.api.comp.domain.SiteInfo">
		<result property="rowNum" column="rowNum"/>
		<result property="siteSeq" column="siteSeq"/>
		<result property="compSeq" column="compSeq"/>
		<result property="compNm" column="compNm"/>
		<result property="projSeq" column="projSeq"/>
		<result property="projNm" column="projNm"/>
		<result property="projSwNm" column="projSwNm"/>
		<result property="projStdYmd" column="projStdYmd"/>
		<result property="projEndYmd" column="projEndYmd"/>
		<result property="siteNm" column="siteNm"/>
		<result property="siteSwNm" column="siteSwNm"/>
		<result property="siteGbCd" column="siteGbCd"/>
		<result property="siteGb" column="siteGb"/>
		<result property="useYn" column="useYn"/>
		<result property="regDt" column="regDt"/>
		<result property="regNm" column="regNm"/>
		<result property="updtDt" column="updtDt"/>
		<result property="updtNm" column="updtNm"/>
	</resultMap>
	
	<!-- 프로젝트 사이트 목록 조회 -->	
	<select id="listSite" parameterType="hashMap"
		resultMap="resultSiteMap">
		<include refid="selectSite"></include>
		<if test='compSeq != null and compSeq != ""'>
			AND PROJ.COMP_SEQ = #{compSeq}
		</if>		
		<if test='projSeq != null and projSeq != ""'>
			AND PROJ.PROJ_SEQ = #{projSeq}
		</if>		
		<if test='search != null and search != ""'>
			AND SITE.SITE_NM LIKE CONCAT('%', #{search}, '%') 
			OR SITE.SITE_SW_NM LIKE CONCAT('%', #{search}, '%') 
			OR COMP.COMP_NM LIKE CONCAT('%', #{search}, '%') 
		</if>			
		ORDER BY SITE.SITE_SEQ DESC
		<if test='pagination != null and pagination != ""'>
			LIMIT #{pagination.limitPerPage} OFFSET #{pagination.offset}
		</if>
	</select>	

	<!-- 프로젝트 사이트 수 -->	
	<select id="countSite" parameterType="hashMap"
		resultType="int">
		SELECT 
			COUNT(SITE.SITE_SEQ)
		FROM TB_SITE SITE
		INNER JOIN TB_COMPANY COMP ON SITE.COMP_SEQ = COMP.COMP_SEQ
		INNER JOIN TB_PROJ PROJ ON SITE.PROJ_SEQ = PROJ.PROJ_SEQ
		WHERE SITE.USE_YN = 'Y'
		<if test='compSeq != null and compSeq != ""'>
			AND PROJ.COMP_SEQ = #{compSeq}
		</if>		
		<if test='projSeq != null and projSeq != ""'>
			AND PROJ.PROJ_SEQ = #{projSeq}
		</if>	
		<if test='search != null and search != ""'>
			AND SITE.SITE_NM LIKE CONCAT('%', #{search}, '%') 
			OR SITE.SITE_SW_NM LIKE CONCAT('%', #{search}, '%') 
			OR COMP.COMP_NM LIKE CONCAT('%', #{search}, '%') 
		</if>				
	</select>	

	<!-- 프로젝트별 사이트 목록 조회 -->
	<select id="listSiteByProjSeq" parameterType="long"
		resultMap="resultSiteMap">
		<include refid="selectSite"></include>
			AND PROJ.PROJ_SEQ = #{projSeq}
		ORDER BY SITE.SITE_SEQ DESC
	</select>		

	<!-- 프로젝트 사이트 단일 조회 -->	
	<select id="getSiteBySeq" parameterType="com.iwi.iwms.api.comp.domain.Site"
		resultMap="resultSiteMap">
		<include refid="selectSite"></include>
			AND SITE.SITE_SEQ = #{siteSeq}
	</select>	

	<!-- 프로젝트 사이트 등록 -->
	<insert id="insertSite" parameterType="com.iwi.iwms.api.comp.domain.Site"
		useGeneratedKeys="true" keyProperty="siteSeq">
		INSERT INTO TB_SITE
		(
		    PROJ_SEQ
		    , COMP_SEQ
		    , SITE_NM
		    , SITE_SW_NM
		    , SITE_GB_CD
			, USE_YN
			, REG_DT
			, REG_SEQ
		) VALUES (
		   #{projSeq}
			, (SELECT COMP_SEQ FROM TB_PROJ WHERE PROJ_SEQ = #{projSeq})
			, #{siteNm}
			, #{siteSwNm}
			, #{siteGbCd}
			, #{useYn}
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
	</insert>		

	<!-- 프로젝트 사이트 수정 -->
	<update id="updateSite" parameterType="com.iwi.iwms.api.comp.domain.Site">
		UPDATE TB_SITE 
		SET
		    SITE_NM = #{siteNm}
			, SITE_SW_NM = #{siteSwNm}
			, SITE_GB_CD = #{siteGbCd}
			, USE_YN = #{useYn}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE PROJ_SEQ = #{projSeq}	
	</update>	

	<!-- 프로젝트 사이트 삭제 -->	
	<delete id="deleteSite" parameterType="com.iwi.iwms.api.comp.domain.Site">
		DELETE 
		FROM TB_SITE
		WHERE SITE_SEQ = #{siteSeq}	 
	</delete>
		
</mapper>