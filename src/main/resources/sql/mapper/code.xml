<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.code.mapper.CodeMapper">

	<resultMap id="resultCodeMap" type="com.iwi.iwms.api.code.domain.CodeInfo">
		<result property="codeSeq" column="codeSeq"/>
		<result property="codeCd" column="codeCd"/>
		<result property="codeNm" column="codeNm"/>
		<result property="upCodeCd" column="upCodeCd"/>
		<result property="codeGbCd" column="codeGbCd"/>
		<result property="codeOrder" column="codeOrder"/>
		<result property="useYn" column="useYn"/>
		<result property="regDt" column="regDt"/>
		<result property="regNm" column="regNm"/>
		<result property="updtDt" column="updtDt"/>
		<result property="updtNm" column="updtNm"/>
		
	   	<collection property="childCodes" column="codeCd" 
			ofType="com.iwi.iwms.api.code.domain.CodeInfo" select="listCodeByUpCode"/>
	</resultMap>

	<!-- 공통 코드 부모 목록 조회 -->	
	<select id="listCode" parameterType="hashMap"
		resultMap="resultCodeMap">
		SELECT 
			CODE.CODE_SEQ AS codeSeq
			, CODE.CODE_CD AS codeCd
			, CODE.CODE_NM AS codeNm
			, CODE.UP_CODE_CD AS upCodeCd
			, CODE.CODE_GB_CD AS codeGbCd
			, CODE.CODE_ORDER AS codeOrder
			, CODE.USE_YN AS useYn
			, DATE_FORMAT(CODE.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, REG_USER.USER_NM AS regNm
			, DATE_FORMAT(CODE.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, UPDT_USER.USER_NM AS updtNm			
		FROM TB_CODE CODE
		LEFT JOIN TB_USER REG_USER ON CODE.REG_SEQ = REG_USER.USER_SEQ
		LEFT JOIN TB_USER UPDT_USER ON CODE.UPDT_SEQ = UPDT_USER.USER_SEQ 
        WHERE CODE.UP_CODE_CD IS NULL
        AND CODE.USE_YN = 'Y'
		<if test='search != null and search != ""'>
			AND CODE.CODE_CD LIKE CONCAT('%', #{search}, '%') 
			OR CODE.CODE_NM LIKE CONCAT('%', #{search}, '%') 
		</if>		
        ORDER BY CODE.CODE_SEQ DESC
	</select>

	<!-- 공통 코드 자식 목록 조회 -->	
	<select id="listCodeByUpCode" resultType="com.iwi.iwms.api.code.domain.CodeInfo">
		SELECT 
			CODE.CODE_SEQ AS codeSeq
			, CODE.CODE_CD AS codeCd
			, CODE.CODE_NM AS codeNm
			, CODE.UP_CODE_CD AS upCodeCd
			, CODE.CODE_GB_CD AS codeGbCd
			, CODE.CODE_ORDER AS codeOrder
			, CODE.USE_YN AS useYn
			, DATE_FORMAT(CODE.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, REG_USER.USER_NM AS regNm
			, DATE_FORMAT(CODE.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, UPDT_USER.USER_NM AS updtNm	
		FROM TB_CODE CODE
		LEFT JOIN TB_USER REG_USER ON CODE.REG_SEQ = REG_USER.USER_SEQ
		LEFT JOIN TB_USER UPDT_USER ON CODE.UPDT_SEQ = UPDT_USER.USER_SEQ 
		WHERE CODE.UP_CODE_CD IS NOT NULL
		AND CODE.USE_YN = 'Y'
		AND CODE.UP_CODE_CD = #{codeCd}
		ORDER BY CODE.CODE_ORDER
	</select>

	<!-- 공통 코드 등록 -->	
	<insert id="insertCode" parameterType="com.iwi.iwms.api.code.domain.Code"
		useGeneratedKeys="true" keyProperty="codeSeq">
		INSERT INTO TB_CODE
		(
		    CODE_CD
		    , CODE_NM
			, UP_CODE_CD
			, CODE_GB_CD
			, CODE_ORDER
			, USE_YN
			, REG_DT
			, REG_SEQ
		) VALUES (
		    #{codeCd}
			, #{codeNm}
			, #{upCodeCd}
			, #{codeGbCd}
			, #{codeOrder}
			, #{useYn}
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
	</insert>		

	<!-- 공통 코드 수정 -->
	<update id="updateCode" parameterType="com.iwi.iwms.api.code.domain.Code">
		UPDATE TB_CODE 
		SET
		    CODE_NM = #{CODE_NM}
			, UP_CODE_CD = #{upCodeCd}
			, CODE_GB_CD = #{codeGbCd}
			, CODE_ORDER = #{codeOrder}
			, USE_YN = #{useYn}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE CODE_SEQ = #{codeSeq}	
	</update>	

	<!-- 공통 코드 삭제 -->	
	<delete id="deleteCode" parameterType="com.iwi.iwms.api.code.domain.Code">
		DELETE 
		FROM TB_CODE
		WHERE CODE_SEQ = #{codeSeq}	 
	</delete>
		
</mapper>