<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.req.mapper.ReqDtlCmtMapper">

	<sql id="selectReqDtlCmt">
		SELECT
			ROW_NUMBER() OVER(ORDER BY CMT.REQ_DTL_CMT_SEQ) AS rowNum
			, CMT.REQ_DTL_CMT_SEQ AS reqDtlCmtSeq
			, REQ.REQ_SEQ AS reqSeq
			, REQ.REQ_NO AS reqNo
			, CMT.REQ_DTL_SEQ AS reqDtlSeq
			, CMT.REQ_DTL_NO AS reqDtlNo
			, CMT.REQ_DTL_CMT AS reqDtlCmt
			, CMT.USER_SEQ AS userSeq
			, FN_GET_USER_NM(CMT.USER_SEQ) AS userNm
			, CMT.DEL_YN AS delYn
			, DATE_FORMAT(CMT.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, FN_GET_USER_NM(CMT.REG_SEQ) AS regNm
			, DATE_FORMAT(CMT.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, FN_GET_USER_NM(CMT.UPDT_SEQ) AS updtNm
			, 'TB_REQ_DTL_CMT' AS fileRefTb
			, 'REQ_DTL_CMT_SEQ' AS fileRefCol			
		FROM TB_REQ REQ
		INNER JOIN TB_REQ_DTL DTL ON REQ.REQ_SEQ = DTL.REQ_SEQ
		INNER JOIN TB_REQ_DTL_CMT CMT ON DTL.REQ_DTL_SEQ = CMT.REQ_DTL_SEQ
		WHERE CMT.DEL_YN = 'N'
	</sql>

	<resultMap id="resultReqDtlCmtMap" type="com.iwi.iwms.api.req.domain.ReqDtlCmtInfo">
		<result property="reqDtlCmtSeq" column="reqDtlCmtSeq"/>
	   	<collection property="attachedFiles" column="fileRefTb=fileRefTb,fileRefCol=fileRefCol,fileRefSeq=reqDtlCmtSeq" 
			ofType="com.iwi.iwms.api.file.domain.UploadFileInfo" select="com.iwi.iwms.api.file.mapper.FileMapper.listFileByRef"/>
	</resultMap>
		
	<!-- 요청사항 상세별 코멘트 목록 조회 -->			
	<select id="listReqDtlCmtByReqDtlSeq" parameterType="long"
		resultMap="resultReqDtlCmtMap">
		<include refid="selectReqDtlCmt"></include>
			AND CMT.REQ_DTL_SEQ = #{reqDtlSeq}
		ORDER BY CMT.REQ_DTL_CMT_SEQ DESC	
	</select>	
		
	<!-- 요청사항 상세 코멘트 단일 조회 -->				
	<select id="getReqDtlCmtBySeq" parameterType="long"
		resultMap="resultReqDtlCmtMap">
		<include refid="selectReqDtlCmt"></include>
			AND CMT.REQ_DTL_CMT_SEQ = #{reqDtlCmtSeq}
	</select>	
		
	<!-- 요청사항 상세 코멘트 등록 -->		
	<insert id="insertReqDtlCmt" parameterType="com.iwi.iwms.api.req.domain.ReqDtlCmt"
				useGeneratedKeys="true" keyProperty="reqDtlCmtSeq">
		INSERT INTO TB_REQ_DTL_CMT
		(
		    REQ_DTL_SEQ
		    , REQ_DTL_NO
			, REQ_DTL_CMT
			, USER_SEQ
			, DEL_YN
			, REG_DT
			, REG_SEQ
		) VALUES (
			#{reqDtlSeq}
			, #{reqDtlNo}
			, #{reqDtlCmt}
			, #{userSeq}
			, 'N'
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
	</insert>		

	<!-- 요청사항 상세 코멘트 수정 -->		
	<update id="updateReqDtlCmt" parameterType="com.iwi.iwms.api.req.domain.ReqDtlCmt">
		UPDATE TB_REQ_DTL_CMT 
		SET
		   REQ_DTL_CMT = #{reqDtlCmt}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE REQ_DTL_CMT_SEQ = #{reqDtlCmtSeq}	
	</update>

	<!-- 요청사항 상세 코멘트 삭제 -->		
	<delete id="deleteReqDtlCmt" parameterType="com.iwi.iwms.api.req.domain.ReqDtlCmt">
		DELETE 
		FROM TB_REQ_DTL_CMT
		WHERE REQ_DTL_CMT_SEQ = #{reqDtlCmtSeq}	 
	</delete>
</mapper>