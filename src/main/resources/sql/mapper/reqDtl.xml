<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.req.mapper.ReqDtlMapper">

	<sql id="selectReqDtl">
		SELECT
			ROW_NUMBER() OVER(ORDER BY DTL.REQ_DTL_SEQ) AS rowNum
			, DTL.REQ_SEQ AS reqSeq
			, DTL.REQ_NO AS reqNo
			, DTL.REQ_DTL_SEQ AS reqDtlSeq
			, DTL.REQ_DTL_NO AS reqDtlNo
			, DTL.REQ_DTL_NM AS reqDtlNm
			, DTL.REQ_DTL_CONTENT_TXT AS reqDtlContentTxt
			, DTL.DTL_SITE_GB_CD AS dtlSiteGbCd
			, FN_GET_CODE_NM('DTL_SITE_GB_CD', DTL.DTL_SITE_GB_CD) AS dtlSiteGb
			, DTL.REQ_GB_CD AS reqGbCd
			, FN_GET_CODE_NM('REQ_DTL_STAT_CD', DTL.REQ_DTL_STAT_CD) AS reqGb
			, DTL.SITE_GB_CD_STR AS siteGbCdStr
			, DTL.REQ_DTL_STAT_CD AS reqDtlStatCd
			, FN_GET_CODE_NM('REQ_GB_CD', DTL.REQ_GB_CD) AS reqDtlStat
			, DTL.REQ_DTL_STAT_CMT AS reqDtlStatCmt
			, DTL.TGT_YMD AS tgtYmd
			, DTL.TGT_MM AS tgtMm
			, DTL.MNG_OK_YMD AS mngOkYmd
			, DTL.MNG_OK_SEQ AS mngOkSeq
			, DTL.CUS_OK_YMD AS cusOkYmd
			, DTL.CUS_OK_SEQ AS cusOkSeq
			, DTL.RETURN_YMD AS returnYmd
			, DTL.RETURN_SEQ AS returnSeq
			, DTL.REQ_DTL_SCORE AS reqDtlScore
			, DTL.REQ_DTL_EVAL_COTENT_CMT AS reqDtlEvalCotentCmt
			, DATE_FORMAT(DTL.DEL_DT, "%Y-%m-%d %H:%i:%s") AS delDt
			, DTL.DEL_YN AS delYn
			, DATE_FORMAT(DTL.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, FN_GET_USER_NM(DTL.REG_SEQ) AS regNm
			, DATE_FORMAT(DTL.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, FN_GET_USER_NM(DTL.UPDT_SEQ) AS updtNm			
		FROM TB_REQ_DTL DTL
		INNER JOIN TB_REQ REQ ON DTL.REQ_SEQ = REQ.REQ_SEQ 
		WHERE DTL.DEL_YN = 'N'
	</sql>

	<resultMap id="resultReqDtlMap" type="com.iwi.iwms.api.req.domain.ReqDtlInfo">
		<result property="reqDtlSeq" column="reqDtlSeq"/>
	   	<collection property="comments" column="reqDtlSeq" 
			ofType="com.iwi.iwms.api.req.domain.ReqDtlCmtInfo" select="com.iwi.iwms.api.req.mapper.ReqDtlCmtMapper.listReqDtlCmtByReqDtlSeq"/>
		<collection property="users" column="reqDtlSeq" 
			ofType="com.iwi.iwms.api.req.domain.ReqDtlUserInfo" select="com.iwi.iwms.api.req.mapper.ReqDtlUserMapper.listReqDtlUserByReqDtlSeq"/>
	</resultMap>
	
	<!-- 요청사항 상세 목록 조회 -->		
	<select id="listReqDtlByReqSeq" parameterType="long"
		resultMap="resultReqDtlMap">
		<include refid="selectReqDtl"></include>
			AND DTL.REQ_SEQ = #{reqSeq}
		ORDER BY DTL.REQ_DTL_SEQ DESC	
	</select>	

	<!-- 요청사항 상세 단일 조회 -->		
	<select id="getReqDtlBySeq" parameterType="long"
		resultMap="resultReqDtlMap">
		<include refid="selectReqDtl"></include>
			AND DTL.REQ_DTL_SEQ = #{reqDtlSeq}
	</select>	

	<!-- 요청사항 상세 등록 -->	
	<insert id="insertReqDtl" parameterType="com.iwi.iwms.api.req.domain.ReqDtl">
		INSERT INTO TB_REQ_DTL
		(
		    REQ_DTL_NO
		    , REQ_SEQ
			, REQ_NO
			, REQ_DTL_NM
			, REQ_DTL_CONTENT_TXT
			, DTL_SITE_GB_CD
			, REQ_GB_CD
			, SITE_GB_CD_STR
			, REQ_DTL_STAT_CD
			, TGT_YMD
			, TGT_MM
			, DEL_YN
			, REG_DT
			, REG_SEQ
		) VALUES (
		    (
				SELECT
					CONCAT(#{reqNo}, '-', LPAD(COALESCE(MAX(SUBSTR(S_REQ_DTL.REQ_DTL_NO, 12)), 0) + 1, 2, 0))
				FROM TB_REQ_DTL AS S_REQ_DTL
                WHERE S_REQ_DTL.REQ_NO = #{reqNo}
				LIMIT 1	    
		    )
			, #{reqSeq}
			, #{reqNo}
			, #{reqDtlNm}
			, #{reqDtlContentTxt}
			, #{dtlSiteGbCd}
			, #{reqGbCd}
			, #{siteGbCdStr}
			, '00'
			, #{tgtYmd}
			, #{tgtMm}
			, 'N'
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
		<selectKey keyColumn="REQ_DTL_SEQ,REQ_DTL_NO,REQ_DTL_STAT_CD" keyProperty="reqDtlSeq,reqDtlNo,reqDtlStatCd" resultType="map" order="AFTER">
        	SELECT 
        		REQ_DTL_SEQ
        		, REQ_DTL_NO
        		, REQ_DTL_STAT_CD
        	FROM TB_REQ_DTL
        	WHERE REQ_DTL_SEQ = LAST_INSERT_ID()
    	</selectKey>
	</insert>	
	
	<!-- 요청사항 상세 수정 -->	
	<update id="updateReqDtl" parameterType="com.iwi.iwms.api.req.domain.ReqDtl">
		UPDATE TB_REQ_DTL 
		SET
			REQ_DTL_NM = #{reqDtlNm}
			, REQ_DTL_CONTENT_TXT = #{reqDtlContentTxt}
			, TGT_YMD = #{tgtYmd}
			, TGT_MM = #{tgtMm}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE REQ_DTL_SEQ = #{reqDtlSeq}	
	</update>
	
	<!-- 요청사항 상세 삭제 -->	
	<delete id="deleteReqDtl" parameterType="com.iwi.iwms.api.req.domain.ReqDtl">
		DELETE 
		FROM TB_REQ_DTL
		WHERE REQ_DTL_SEQ = #{reqDtlSeq}	 
	</delete>
	
	<insert id="insertReqDtlHis" parameterType="com.iwi.iwms.api.req.domain.ReqDtl">
		INSERT INTO TB_REQ_DTL_HIS
		(
		    REQ_DTL_SEQ
		    , REQ_DTL_NO
			, REQ_DTL_STAT_CD
			, REG_YMD
			, REG_DT
			, REG_SEQ
		) VALUES (
			#{reqDtlSeq}
			, #{reqDtlNo}
			, #{reqDtlStatCd}
			, DATE_FORMAT(CURRENT_TIMESTAMP, "%Y%m%d")
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
	</insert>	
		
	<!-- 유지보수상세 처리상태 업데이트 
	<update id="updateStat" parameterType="com.iwi.iwms.api.req.domain.ReqDtl">
		UPDATE  TB_REQ_DTL
		SET     REQ_DTL_STAT_CD    = #{reqDtlStatCd}
		        , REQ_DTL_STAT_CMT = #{reqDtlStatCmt}
		        , MNG_OK_DT        = SYSDATE
		        , MNG_OK_SEQ       = #{mngOkSeq}
		        , MNG_OK_IP        = #{mngOkIp}
		        , UPD_DT           = SYSDATE
		        , UPD_SEQ          = #{updSeq}
		        , UPD_IP           = #{updIp}
		WHERE   REQ_DTL_NO = #{reqDtlNo}
	</update>	
	-->	
</mapper>