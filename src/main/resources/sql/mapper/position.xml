<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iwi.iwms.api.comp.mapper.PositionMapper">

	<resultMap id="resultPositionMap" type="com.iwi.iwms.api.comp.domain.PositionInfo">
		<result property="rowNum" column="rowNum"/>
		<result property="positionSeq" column="positionSeq"/>
		<result property="positionNm" column="positionNm"/>
		<result property="compSeq" column="compSeq"/>
		<result property="compNm" column="compNm"/>
		<result property="useYn" column="useYn"/>
		<result property="regDt" column="regDt"/>
		<result property="regNm" column="regNm"/>
		<result property="updtDt" column="updtDt"/>
		<result property="updtNm" column="updtNm"/>
	</resultMap>
	
	<sql id="selectPosition">
		SELECT 
			ROW_NUMBER() OVER(ORDER BY POSI.POSITION_SEQ) AS rowNum
			, POSI.POSITION_SEQ AS positionSeq
			, POSI.POSITION_NM AS positionNm
			, POSI.COMP_SEQ AS compSeq
			, COMP.COMP_NM AS compNm
			, POSI.USE_YN AS useYn
			, DATE_FORMAT(POSI.REG_DT, "%Y-%m-%d %H:%i:%s") AS regDt
			, REG_USER.USER_NM AS regNm
			, DATE_FORMAT(POSI.UPDT_DT, "%Y-%m-%d %H:%i:%s") AS updtDt
			, UPDT_USER.USER_NM AS updtNm
		FROM TB_POSITION POSI
		INNER JOIN TB_COMPANY COMP ON POSI.COMP_SEQ = COMP.COMP_SEQ
		LEFT JOIN TB_USER REG_USER ON POSI.REG_SEQ = REG_USER.USER_SEQ
		LEFT JOIN TB_USER UPDT_USER ON POSI.UPDT_SEQ = UPDT_USER.USER_SEQ 
		WHERE POSI.USE_YN = 'Y'
	</sql>

	<!-- 직급 목록 조회 -->		
	<select id="listPosition" parameterType="hashMap"
		resultMap="resultPositionMap">
		<include refid="selectPosition"></include>
		<if test='compSeq != null and compSeq != ""'>
			AND POSI.COMP_SEQ = #{compSeq}
		</if>
		<if test='search != null and search != ""'>
			AND POSI.POSITION_NM LIKE CONCAT('%', #{search}, '%') 
		</if>			
		ORDER BY POSI.COMP_SEQ, POSI.POSITION_SEQ DESC
		<if test='pagination != null and pagination != ""'>
			LIMIT #{pagination.limitPerPage} OFFSET #{pagination.offset}
		</if>
	</select>	

	<!-- 소속별 직급 목록 조회 -->
	<select id="listPositionByCompSeq" parameterType="long"
		resultMap="resultPositionMap">
		<include refid="selectPosition"></include>
			AND POSI.COMP_SEQ = #{compSeq}
		ORDER BY POSI.POSITION_SEQ DESC		
	</select>		
	
	<!-- 직급 단일 조회 -->	
	<select id="getPositionBySeq" parameterType="com.iwi.iwms.api.comp.domain.Position"
		resultMap="resultPositionMap">
		<include refid="selectPosition"></include>
		AND POSI.POSITION_SEQ = #{positionSeq}
	</select>	

	<!-- 직급 등록 -->
	<insert id="insertPosition" parameterType="com.iwi.iwms.api.comp.domain.Position"
		useGeneratedKeys="true" keyProperty="positionSeq">
		INSERT INTO TB_POSITION
		(
			POSITION_NM
			, COMP_SEQ
			, USE_YN
			, REG_DT
			, REG_SEQ
		) VALUES (
			#{positionNm}
			, #{compSeq}
			, #{useYn}
			, CURRENT_TIMESTAMP
			, #{regSeq}
		)		
	</insert>		

	<!-- 직급 수정 -->
	<update id="updatePosition" parameterType="com.iwi.iwms.api.comp.domain.Position">
		UPDATE TB_POSITION 
		SET
		    POSITION_NM = #{positionNm}
			, USE_YN = #{useYn}
			, UPDT_DT = CURRENT_TIMESTAMP
			, UPDT_SEQ = #{updtSeq}
		WHERE POSITION_SEQ = #{positionSeq}	
	</update>	

	<!-- 직급 삭제 -->	
	<delete id="deletePosition" parameterType="com.iwi.iwms.api.comp.domain.Position">
		DELETE 
		FROM TB_POSITION
		WHERE POSITION_SEQ = #{positionSeq}	 
	</delete>
		
</mapper>